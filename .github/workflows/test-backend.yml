name: Backend Integration Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  # Deprecated: test-backend workflow is superseded by .github/workflows/ci.yml
  # Keep this file for historical reasons, but disable it to avoid duplicate runs.
  test-backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.3.2'

      - name: Log Bun and bunfig
        run: |
          cd backend || exit 1
          bun --version || true
          echo "--- backend/bunfig.toml ---"
          cat bunfig.toml || true

      - name: Install backend deps
        working-directory: backend
        run: |
          bun install --frozen-lockfile

      - name: Build backend
        working-directory: backend
        run: bun run build

      - name: Assert PDF fixture exists (CI gating)
        run: |
          # Only enforce PDF fixture presence when RUN_PDF_FIXTURES=1 to avoid
          # blocking contributors or environments that don't include binary
          # fixtures. When unset or !=1, skip with a warning.
          FIXTURE=tests/fixtures/sample.pdf
          if [ "${RUN_PDF_FIXTURES:-0}" = "1" ]; then
            if [ -f "$FIXTURE" ]; then
              echo "Found PDF fixture: $FIXTURE"
            else
              echo "WARNING: Required PDF fixture missing: $FIXTURE - PDF tests will be skipped in this run"
              # do not fail CI; skip PDF-dependent tests by leaving tests to handle missing fixture
            fi
          else
            echo "Skipping PDF fixture check (RUN_PDF_FIXTURES!=1)"
          fi

      - name: Run backend tests (in-process)
        run: |
          # Ensure we run from backend so backend/bunfig.toml is picked up and tests in repo-root are executed
          cd backend || exit 1
          export RUN_PDF_FIXTURES=1
          # Run tests from the repo test directory to ensure we exercise the canonical tests
          bun test ../tests/backend/ --coverage --reporter=json | tee /tmp/bun_test_output.txt
          if grep -q "Ran 0 tests" /tmp/bun_test_output.txt; then
            echo "ERROR: No tests discovered (0 tests). Check working-directory and test paths.";
            cat /tmp/bun_test_output.txt;
            exit 1;
          fi

  # Postgres-backed job to validate Bun Postgres integration in CI.
  test-backend-postgres:
    runs-on: ubuntu-latest
    needs: test-backend
    env:
      OM_METADATA_BACKEND: 'postgres'
      OM_PG_HOST: '127.0.0.1'
      OM_PG_PORT: '5432'
      OM_PG_DB: 'openmemory'
      OM_PG_USER: 'om'
      OM_PG_PASSWORD: 'om_pass'
      OM_PG_SCHEMA: 'public'
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: openmemory
          POSTGRES_USER: om
          POSTGRES_PASSWORD: om_pass
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready -U om
          --health-interval 5s
          --health-timeout 5s
          --health-retries 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.3.2'

      - name: Log Bun and bunfig
        run: |
          cd backend || exit 1
          bun --version || true
          echo "--- backend/bunfig.toml ---"
          cat bunfig.toml || true

      - name: Wait for Postgres
        run: |
          sudo apt-get update -y
          sudo apt-get install -y postgresql-client
          echo "Waiting for Postgres to be ready..."
          for i in {1..60}; do
            pg_isready -h 127.0.0.1 -p 5432 -U om && break || sleep 1
          done

      - name: DB cleanup (only when using Postgres)
        if: env.OM_METADATA_BACKEND == 'postgres'
        run: |
          echo "Installing psql client for DB cleanup..."
          sudo apt-get update -y
          sudo apt-get install -y postgresql-client
          echo "Cleaning up Postgres schema to ensure a fresh test DB"
          export PGPASSWORD="${{ job.env.OM_PG_PASSWORD }}"
          # Retry drop/create if Postgres is still warming up
          for attempt in 1 2 3; do
            PGPASSWORD="$PGPASSWORD" psql -h ${{ job.env.OM_PG_HOST }} -U ${{ job.env.OM_PG_USER }} -d ${{ job.env.OM_PG_DB }} -c "DROP SCHEMA public CASCADE; CREATE SCHEMA public;" && break || {
              echo "Attempt $attempt: DB cleanup failed, retrying in $((attempt * 5))s..."
              sleep $((attempt * 5))
            }
          done

      - name: Check Bun Postgres support
        id: check_pg
        run: |
          cd backend || exit 1
          # Check common Bun Postgres entry points. Print a boolean and set job output.
          if bun -e "console.log(typeof (globalThis.Bun?.connectPostgres) === 'function' || typeof (globalThis.Bun?.postgres) === 'function' || typeof (globalThis.Bun?.Postgres) === 'function')" | grep -q true; then
            echo "has_pg=true" >> $GITHUB_OUTPUT
          else
            echo "has_pg=false" >> $GITHUB_OUTPUT
          fi

      - name: Install backend deps
        if: steps.check_pg.outputs.has_pg == 'true'
        working-directory: backend
        run: |
          bun install --frozen-lockfile || bun install

      - name: Build backend
        if: steps.check_pg.outputs.has_pg == 'true'
        working-directory: backend
        run: bun run build

      - name: Assert PDF fixture exists (CI gating)
        if: steps.check_pg.outputs.has_pg == 'true'
        run: |
          FIXTURE=tests/fixtures/sample.pdf
          if [ "${RUN_PDF_FIXTURES:-0}" = "1" ]; then
            if [ -f "$FIXTURE" ]; then
              echo "Found PDF fixture: $FIXTURE"
            else
              echo "WARNING: Required PDF fixture missing: $FIXTURE - PDF tests will be skipped in this run"
            fi
          else
            echo "Skipping PDF fixture check (RUN_PDF_FIXTURES!=1)"
          fi

      - name: Run backend tests (Postgres)
        if: steps.check_pg.outputs.has_pg == 'true'
        run: |
          # Run tests with OM_METADATA_BACKEND=postgres to exercise Bun Postgres path
          export OM_METADATA_BACKEND=postgres
          export OM_PG_HOST=127.0.0.1
          export OM_PG_PORT=5432
          export OM_PG_DB=openmemory
          export OM_PG_USER=om
          export OM_PG_PASSWORD=om_pass

          MAX_ATTEMPTS=3
          ATTEMPT=1
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Test attempt $ATTEMPT/$MAX_ATTEMPTS"
            cd backend || exit 1
            export RUN_PDF_FIXTURES=1
            bun test ../tests/backend/ --coverage --reporter=json | tee /tmp/bun_test_output_postgres.txt
            if ! grep -q "Ran 0 tests" /tmp/bun_test_output_postgres.txt; then
              echo "Tests discovered and run.";
              break
            fi
            if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
              SLEEP_TIME=$((ATTEMPT * 10))
              echo "Tests failed on attempt $ATTEMPT. Sleeping $SLEEP_TIME seconds before retry..."
              sleep $SLEEP_TIME
            else
              echo "Tests failed after $MAX_ATTEMPTS attempts. Exiting with failure."
              cat /tmp/bun_test_output_postgres.txt
              exit 1
            fi
            ATTEMPT=$((ATTEMPT+1))
          done

      - name: Skip Postgres tests message
        if: steps.check_pg.outputs.has_pg == 'false'
        run: |
          echo "Skipping Postgres-backed tests because Bun Postgres client not available in this runner. To force, use a Bun runtime with Postgres support or set up a runner that includes Bun Postgres."
