name: CI

on:
  push:
  pull_request:

jobs:
  backend:
    name: Backend tests (Bun)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
      - name: Cache Bun deps
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun
            backend/bun.lockb
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
      - name: Install backend deps
        working-directory: backend
        run: |
          bun install --no-save
      - name: Run backend tests
        working-directory: backend
        run: |
          bun test --coverage
      - name: Upload backend coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage
          path: backend/coverage

  sdk-js:
    name: SDK JS tests (Bun)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
      - name: Install SDK-JS deps
        working-directory: sdk-js
        run: |
          bun install --no-save || true
      - name: Cache SDK-JS bun deps
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun
            sdk-js/bun.lockb
          key: ${{ runner.os }}-sdkjs-bun-${{ hashFiles('sdk-js/**/bun.lockb') }}
      - name: Run SDK-JS tests
        working-directory: sdk-js
        run: |
          bun test

  sdk-py:
    name: SDK Python tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      - name: Cache pip and venv
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            sdk-py/.venv
          key: ${{ runner.os }}-sdkpy-pip-${{ hashFiles('**/sdk-py/pyproject.toml') }}
      - name: Create venv and install pytest
        run: |
          python -m venv sdk-py/.venv
          source sdk-py/.venv/bin/activate
          python -m pip install --upgrade pip
          pip install pytest pytest-cov
      - name: Run SDK-Py tests
        env:
          PYTHONPATH: ${{ github.workspace }}/sdk-py
        run: |
          source sdk-py/.venv/bin/activate
          python -m pytest -q sdk-py

  backend-postgres-smoke:
    name: Backend Postgres smoke test
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: openmemory
          POSTGRES_PASSWORD: openmemory
          POSTGRES_DB: openmemory
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U openmemory -d openmemory"
          --health-interval 5s
          --health-timeout 5s
          --health-retries 10
    steps:
      - uses: actions/checkout@v4
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
      - name: Wait for Postgres
        run: |
          echo "Waiting for Postgres to be ready"
          for i in {1..20}; do pg_isready -h localhost -p 5432 -U openmemory && break || sleep 1; done
      - name: Install backend deps
        working-directory: backend
        run: |
          bun install --no-save
      - name: Run backend tests against Postgres
        working-directory: backend
        env:
          OM_METADATA_BACKEND: postgres
          OM_PG_HOST: localhost
          OM_PG_PORT: 5432
          OM_PG_USER: openmemory
          OM_PG_PASSWORD: openmemory
          OM_PG_DB: openmemory
        run: |
          bun test --coverage
      - name: Upload backend-postgres coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-postgres-coverage
          path: backend/coverage

  all-success:
    name: All tests successful
    runs-on: ubuntu-latest
    needs: [backend, sdk-js, sdk-py, backend-postgres-smoke]
    steps:
      - name: Aggregate status
        run: |
          echo "All test jobs passed."
