name: Backend Integration Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  # Deprecated: test-backend workflow is superseded by .github/workflows/ci.yml
  # Keep this file for historical reasons, but disable it to avoid duplicate runs.
  test-backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.2"

      - name: Install backend deps
        working-directory: backend
        run: |
          bun install --frozen-lockfile

      - name: Build backend
        working-directory: backend
        run: bun run build

      - name: Run backend tests (in-process)
        working-directory: backend
        run: |
          # Run tests the same way we do locally. Tests start servers in-process
          # and avoid DB lock contention that occurs when a separate background
          # server opens the same SQLite file.
          # Use the package.json test script so path resolution is consistent.
          bun run test

  # Postgres-backed job to validate Bun Postgres integration in CI.
  test-backend-postgres:
    runs-on: ubuntu-latest
    needs: test-backend
    env:
      OM_METADATA_BACKEND: "postgres"
      OM_PG_HOST: "127.0.0.1"
      OM_PG_PORT: "5432"
      OM_PG_DB: "openmemory"
      OM_PG_USER: "om"
      OM_PG_PASSWORD: "om_pass"
      OM_PG_SCHEMA: "public"
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: openmemory
          POSTGRES_USER: om
          POSTGRES_PASSWORD: om_pass
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready -U om
          --health-interval 5s
          --health-timeout 5s
          --health-retries 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.2"

      - name: Wait for Postgres
        run: |
          sudo apt-get update -y
          sudo apt-get install -y postgresql-client
          echo "Waiting for Postgres to be ready..."
          for i in {1..60}; do
            pg_isready -h 127.0.0.1 -p 5432 -U om && break || sleep 1
          done

      - name: DB cleanup (only when using Postgres)
        if: env.OM_METADATA_BACKEND == 'postgres'
        run: |
          echo "Installing psql client for DB cleanup..."
          sudo apt-get update -y
          sudo apt-get install -y postgresql-client
          echo "Cleaning up Postgres schema to ensure a fresh test DB"
          export PGPASSWORD="${{ job.env.OM_PG_PASSWORD }}"
          # Retry drop/create if Postgres is still warming up
          for attempt in 1 2 3; do
            PGPASSWORD="$PGPASSWORD" psql -h ${{ job.env.OM_PG_HOST }} -U ${{ job.env.OM_PG_USER }} -d ${{ job.env.OM_PG_DB }} -c "DROP SCHEMA public CASCADE; CREATE SCHEMA public;" && break || {
              echo "Attempt $attempt: DB cleanup failed, retrying in $((attempt * 5))s..."
              sleep $((attempt * 5))
            }
          done

      - name: Install backend deps
        working-directory: backend
        run: |
          bun install --frozen-lockfile || bun install

      - name: Build backend
        working-directory: backend
        run: bun run build

      - name: Run backend tests (Postgres)
        working-directory: backend
        run: |
          # Run tests with OM_METADATA_BACKEND=postgres to exercise Bun Postgres path
          # Retries: attempt the test up to 3 times on transient CI failures
          export OM_METADATA_BACKEND=postgres
          export OM_PG_HOST=127.0.0.1
          export OM_PG_PORT=5432
          export OM_PG_DB=openmemory
          export OM_PG_USER=om
          export OM_PG_PASSWORD=om_pass

          MAX_ATTEMPTS=3
          ATTEMPT=1
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Test attempt $ATTEMPT/$MAX_ATTEMPTS"
            # Use package script so the test invocation is consistent with local runs
            if bun run test; then
              echo "Tests passed on attempt $ATTEMPT"
              break
            fi
            if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
              SLEEP_TIME=$((ATTEMPT * 10))
              echo "Tests failed on attempt $ATTEMPT. Sleeping $SLEEP_TIME seconds before retry..."
              sleep $SLEEP_TIME
            else
              echo "Tests failed after $MAX_ATTEMPTS attempts. Exiting with failure."
              exit 1
            fi
            ATTEMPT=$((ATTEMPT+1))
          done
