name: Docker Build Test

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

jobs:
  docker-build-test:
    runs-on: ubuntu-latest
    name: Test Docker Build

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: '1.3.1'

      - name: Verify Bun
        run: |
          bun --version
          bun -v || true

      - name: Build Backend Docker Image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: false
          tags: openmemory-backend:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build backend with Bun (smoke)
        working-directory: backend
        run: |
          bun --version
          bun run build || true
          # Verify the build output exists (support dist/server/index.js or dist/index.js)
          if [ -f dist/server/index.js ]; then
            echo "Found dist/server/index.js"
          elif [ -f dist/index.js ]; then
            echo "Found dist/index.js"
          else
            echo "Build did not produce expected entrypoint (dist/server/index.js or dist/index.js)"
            ls -la dist || true
            exit 1
          fi

      - name: Test Docker Compose Build
        run: |
          docker compose build
          docker compose config

      - name: Install Podman
        run: |
          sudo apt-get update
          sudo apt-get install -y podman

      - name: Podman build smoke test
        run: |
          podman build -f backend/Dockerfile -t openmemory-backend:podman-test ./backend

      - name: Postgres smoke test (lightweight)
        run: |
          set -e
          docker network create om-smoke-net || true
          docker run -d --name om_pg --network om-smoke-net -e POSTGRES_PASSWORD=postgres -e POSTGRES_DB=openmemory postgres:15-alpine
          # wait for postgres to accept connections
          for i in $(seq 1 30); do
            docker exec om_pg pg_isready -U postgres && break || sleep 1
          done
          # run the built backend image against the Postgres instance
          docker run -d --name om_backend --network om-smoke-net -p 8081:8080 \
            -e OM_METADATA_BACKEND=postgres \
            -e OM_PG_HOST=om_pg \
            -e OM_PG_PORT=5432 \
            -e OM_PG_DB=openmemory \
            -e OM_PG_USER=postgres \
            -e OM_PG_PASSWORD=postgres \
            -e OM_PORT=8080 \
            openmemory-backend:test
          # wait for backend health endpoint
          max_attempts=30
          attempt=0
          until curl -fsS http://localhost:8081/health || [ $attempt -eq $max_attempts ]; do
            echo "Waiting for backend (postgres mode) to be healthy... (attempt $((attempt+1))/$max_attempts)"
            sleep 2
            attempt=$((attempt+1))
          done
          if [ $attempt -eq $max_attempts ]; then
            echo "Postgres-backed backend failed to become healthy"
            docker logs om_backend || true
            docker logs om_pg || true
            docker rm -f om_backend om_pg || true
            docker network rm om-smoke-net || true
            exit 1
          fi
          echo "✅ Postgres smoke test: backend healthy"
          docker rm -f om_backend om_pg || true
          docker network rm om-smoke-net || true

      - name: Validate podman unit files
        run: |
          # Ensure podman unit and volume files include required sections
          for f in podman/openmemory.container podman/openmemory-data.volume; do
            if [ ! -f "$f" ]; then echo "Missing $f"; exit 1; fi
            grep -q "\[Unit\]" "$f" || (echo "$f missing [Unit]" && exit 1)
            grep -q "\[Container\]\|\[Volume\]" "$f" || (echo "$f missing [Container] or [Volume]" && exit 1)
          done

      - name: Start Services
        run: |
          docker compose up -d
          sleep 10

      - name: Check Health Endpoint
        run: |
          max_attempts=30
          attempt=0
          until curl -f http://localhost:8080/health || [ $attempt -eq $max_attempts ]; do
            echo "Waiting for service to be healthy... (attempt $((attempt+1))/$max_attempts)"
            sleep 2
            attempt=$((attempt+1))
          done

          if [ $attempt -eq $max_attempts ]; then
            echo "Service failed to become healthy"
            docker compose logs
            exit 1
          fi

          echo "✅ Service is healthy!"
          curl -v http://localhost:8080/health

      - name: Show Container Logs
        if: failure()
        run: docker compose logs

      - name: Cleanup
        if: always()
        run: docker compose down -v
