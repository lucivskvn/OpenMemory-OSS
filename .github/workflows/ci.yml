name: CI â€” tests, build, publish

on:
  push:
    branches: [main, next]
  pull_request:
    branches: [main, next]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  detect-changes:
    name: Detect changed paths
    runs-on: ubuntu-latest
    outputs:
      dashboard_changed: ${{ steps.filter.outputs.dashboard }}
      ide_changed: ${{ steps.filter.outputs.ide }}
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Filter paths
        id: filter
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        with:
          filters: |
            dashboard:
              - 'dashboard/app/**'
              - 'dashboard/package.json'
              - 'dashboard/app/**/*'
            ide:
              - 'IDE/src/**'
              - 'IDE/package.json'
              - 'IDE/**/src/**'

    # (detect-changes job steps above)

  # Prettier job moved to top-level (not nested under detect-changes)
  prettier_format:
    name: Prettier format check (repo-wide)
    runs-on: ubuntu-latest
    # Run early to fail fast on formatting issues across backend, dashboard, IDE
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Setup Bun
        uses: oven-sh/setup-bun@4bc047ad259df6fc24a6c9b0f9a0cb08cf17fbe5 # v2.0.1
        with:
          bun-version: "1.3.2"

      - name: Run Prettier check (repo root)
        # Use bunx to run a pinned Prettier quickly; will fail the job if formatting issues exist
        run: |
          echo "Running Prettier check across repository (pinned)"
          bunx -p prettier@3.3.3 prettier --check . || (echo "Prettier formatting issues found. Run 'bunx -p prettier@3.3.3 prettier --write .' locally to fix." && exit 1)

  test-backend:
    needs: [prettier_format]
    name: Backend tests (SQLite)
    runs-on: ubuntu-latest
    env:
      OM_PORT: 8080
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Setup Bun
        uses: oven-sh/setup-bun@4bc047ad259df6fc24a6c9b0f9a0cb08cf17fbe5 # v2.0.1
        with:
          bun-version: "1.3.2"

      - name: Install backend deps
        working-directory: backend
        run: |
          # Enforce frozen lockfile in CI for reproducible installs
          bun install --frozen-lockfile --no-save

      - name: Log resolved backend deps
        working-directory: backend
        run: |
          # Log resolved dependency tree for observability in CI logs
          bun pm ls --all || bun list --all || echo "bun list not available"

      - name: Prettier format
        working-directory: backend
        run: |
          bunx -p prettier@3.3.3 prettier --check . || true

      - name: Dependency security scan
        working-directory: backend
        run: |
          bun run security:scan || true

      - name: Build backend
        working-directory: backend
        run: bun run build

      # Optional CPU profiling steps removed per maintainer request (was causing IDE YAML/schema warnings)

      - name: Run backend tests (SQLite)
        working-directory: backend
        run: |
          # Start a background server bound to $OM_PORT so endpoint tests that
          # expect a running server at OM_PORT (e.g. /health) succeed reliably
          echo "Starting background server on port $OM_PORT"
          bun run start &
          SERVER_PID=$!
          # give server a brief moment to come up and verify /health
          for i in {1..40}; do
            if curl -sSf "http://127.0.0.1:$OM_PORT/health" >/dev/null 2>&1; then
              echo "Server responded on port $OM_PORT"
              break
            fi
            sleep 0.25
          done

          # Run the test suite (tests may also start programmatic servers on other ports)
          # Keep the background server running so tests that expect OM_PORT to be served work.
          # Use package.json test script for consistent invocation
          bun run test
          # Ensure background server is stopped after tests finish
          if ps -p $SERVER_PID >/dev/null 2>&1; then
            echo "Stopping background server (pid=$SERVER_PID)"
            kill $SERVER_PID || true
          fi

  test-backend-postgres:
    needs: [prettier_format]
    name: Backend tests (Postgres)
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: openmemory
          POSTGRES_USER: om
          POSTGRES_PASSWORD: om_pass
        ports:
          - 5432:5432
        options: >-
          --health-cmd 'pg_isready -U om'
          --health-interval 5s
          --health-timeout 5s
          --health-retries 10
    env:
      OM_METADATA_BACKEND: postgres
      OM_PG_HOST: 127.0.0.1
      OM_PG_PORT: 5432
      OM_PG_DB: openmemory
      OM_PG_USER: om
      OM_PG_PASSWORD: om_pass
      OM_PG_SCHEMA: public
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Setup Bun
        uses: oven-sh/setup-bun@4bc047ad259df6fc24a6c9b0f9a0cb08cf17fbe5 # v2.0.1
        with:
          bun-version: "1.3.2"

      - name: Wait for Postgres
        run: |
          sudo apt-get update -y
          sudo apt-get install -y postgresql-client
          echo "Waiting for Postgres to be ready..."
          for i in {1..60}; do
            pg_isready -h 127.0.0.1 -p 5432 -U om && break || sleep 1
          done

      - name: DB cleanup (only when using Postgres)
        if: env.OM_METADATA_BACKEND == 'postgres'
        run: |
          echo "Cleaning up Postgres schema to ensure a fresh test DB"
          export PGPASSWORD="${{ job.env.OM_PG_PASSWORD }}"
          for attempt in 1 2 3; do
            PGPASSWORD="$PGPASSWORD" psql -h ${{ job.env.OM_PG_HOST }} -U ${{ job.env.OM_PG_USER }} -d ${{ job.env.OM_PG_DB }} -c "DROP SCHEMA public CASCADE; CREATE SCHEMA public;" && break || {
              echo "Attempt $attempt: DB cleanup failed, retrying in $((attempt * 5))s..."
              sleep $((attempt * 5))
            }
          done

      - name: Install backend deps
        working-directory: backend
        run: |
          bun install --frozen-lockfile --no-save

      - name: Log resolved backend deps
        working-directory: backend
        run: |
          bun pm ls --all || bun list --all || echo "bun list not available"

      - name: Prettier format
        working-directory: backend
        run: |
          bunx -p prettier@3.3.3 prettier --check . || true

      - name: Dependency security scan
        working-directory: backend
        run: |
          bun run security:scan || true

      - name: Build backend
        working-directory: backend
        run: bun run build

      # Optional CPU profiling steps removed per maintainer request (was causing IDE YAML/schema warnings)

      - name: Run backend tests (Postgres)
        working-directory: backend
        env:
          OM_METADATA_BACKEND: postgres
          OM_PG_HOST: 127.0.0.1
          OM_PG_PORT: 5432
          OM_PG_DB: openmemory
          OM_PG_USER: om
          OM_PG_PASSWORD: om_pass
        run: |
          MAX_ATTEMPTS=3
          ATTEMPT=1
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Test attempt $ATTEMPT/$MAX_ATTEMPTS"
            if bun run test; then
              echo "Tests passed on attempt $ATTEMPT"
              break
            fi
            if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
              SLEEP_TIME=$((ATTEMPT * 10))
              echo "Tests failed on attempt $ATTEMPT. Sleeping $SLEEP_TIME seconds before retry..."
              sleep $SLEEP_TIME
            else
              echo "Tests failed after $MAX_ATTEMPTS attempts. Exiting with failure."
              exit 1
            fi
            ATTEMPT=$((ATTEMPT+1))
          done

  publish-docker:
    name: Build and publish Docker image
    needs: [test-backend, test-backend-postgres]
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read
      packages: write
      id-token: write
      attestations: write
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@343f7c4344506bcbf9b4de18042ae17996df046d # v3.0.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push image
        id: build-and-push
        uses: docker/build-push-action@4a13e500e55cf31b7a5d59a38ab2040ab0f42f56 # v5.1.0
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository }}:latest
            ghcr.io/${{ github.repository }}:${{ github.sha }}
          platforms: linux/amd64,linux/arm64

      # SLSA provenance enables supply-chain verification; use
      # `gh attestation verify oci://ghcr.io/${{ github.repository }}:${{ github.sha }}` to validate builds.
      - name: Attest Build Provenance
        uses: actions/attest-build-provenance@f8d5ea8082b0d9f5ab855907be308fbd7eefb155 # v1.1.0
        with:
          subject-name: ghcr.io/${{ github.repository }}
          subject-digest: ${{ steps.build-and-push.outputs.digest }}
  security-scan:
    name: Security scan
    runs-on: ubuntu-latest
    # Scoped permissions: top-level permissions remain minimal; this job
    # requires `security-events: write` to upload SARIF to the Security tab.
    # We explicitly scope `contents: read` here for clarity.
    permissions:
      contents: read
      security-events: write
    # Depend only on postgres-backed tests. We build a local image for
    # scanning so PRs (where publishing is gated) still get image scans.
    needs: [test-backend-postgres]
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
      - name: Setup Bun
        uses: oven-sh/setup-bun@4bc047ad259df6fc24a6c9b0f9a0cb08cf17fbe5 # v2.0.1
        with:
          bun-version: "1.3.2"
      - name: Install deps
        working-directory: backend
        run: bun install --frozen-lockfile --no-save

      - name: Log resolved backend deps
        working-directory: backend
        run: bun pm ls --all || bun list --all || echo "bun list not available"

      - name: Prepare local Docker builder
        uses: docker/setup-buildx-action@988b5a0280414f521da01fcc63a27aeeb4b104db # v3.6.1

      - name: Build local image for scanning (no push)
        id: build-local-image
        uses: docker/build-push-action@4a13e500e55cf31b7a5d59a38ab2040ab0f42f56 # v5.1.0
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: false
          load: true
          tags: |
            openmemory:scan
          platforms: linux/amd64

      - name: Trivy scan filesystem
        uses: aquasecurity/trivy-action@6e7b7d1fd3e4fef0c5fa8caedf20eb0281bf5b81
        with:
          scan-type: filesystem
          format: sarif
          output: trivy-filesystem.sarif

      - name: Trivy scan local image
        uses: aquasecurity/trivy-action@6e7b7d1fd3e4fef0c5fa8caedf20eb0281bf5b81
        with:
          image-ref: openmemory:scan
          format: sarif
          output: trivy-image.sarif
      - name: Upload SARIF (image)
        uses: github/codeql-action/upload-sarif@768cb5b63a66678bd6d9b69f0e3e3a6b7b1b4b4e # v3.0.0
        with:
          sarif_file: trivy-image.sarif

      - name: Upload SARIF (filesystem)
        uses: github/codeql-action/upload-sarif@768cb5b63a66678bd6d9b69f0e3e3a6b7b1b4b4e # v3.0.0
        with:
          sarif_file: trivy-filesystem.sarif

  build_dashboard:
    name: Build Dashboard (Next.js)
    runs-on: ubuntu-latest
    needs: [detect-changes, prettier_format]
    if: needs.detect-changes.outputs.dashboard_changed == 'true' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Setup Bun
        uses: oven-sh/setup-bun@4bc047ad259df6fc24a6c9b0f9a0cb08cf17fbe5 # v2.0.1
        with:
          bun-version: "1.3.2"

      - name: Install dashboard deps
        working-directory: dashboard
        run: |
          bun install --frozen-lockfile --no-save

      - name: Log resolved dashboard deps
        working-directory: dashboard
        run: |
          bun pm ls --all || bun list --all || echo "bun list not available"

      - name: Build dashboard
        working-directory: dashboard
        run: |
          bun run build

  build_ide:
    name: Build IDE Extension
    runs-on: ubuntu-latest
    needs: [detect-changes, prettier_format]
    if: needs.detect-changes.outputs.ide_changed == 'true' || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1

      - name: Setup Bun
        uses: oven-sh/setup-bun@4bc047ad259df6fc24a6c9b0f9a0cb08cf17fbe5 # v2.0.1
        with:
          bun-version: "1.3.2"

      - name: Install IDE deps
        working-directory: IDE
        run: |
          bun install --frozen-lockfile --no-save

      - name: Log resolved IDE deps
        working-directory: IDE
        run: |
          bun pm ls --all || bun list --all || echo "bun list not available"

      - name: Compile IDE extension
        working-directory: IDE
        run: |
          bun run compile
